# Release bundle walkthrough

The `npm run release:bundle` command packages a production-ready archive that non-technical operators can extract and deploy
without cloning the repository. The generated `tar.gz` file captures contract artifacts, configuration profiles, operational
scripts, and a manifest summarising the governance parameters that will be promoted on-chain.

## Generate a bundle

```bash
npm run build
npm run export:artifacts
npm run release:bundle -- --variant mainnet
```

- `npm run build` and `npm run export:artifacts` ensure `artifacts-public/` contains up-to-date ABIs and address manifests. The
  release builder refuses to run without these prerequisites to avoid stale deployments.
- The bundler writes `dist/agi-jobs-<variant>-<timestamp>.tar.gz` by default. Override the output location via
  `npm run release:bundle -- --out ./agi-jobs-mainnet.tar.gz` when scripting or mirroring.
- Use `-- --variant sepolia` (or any other configured profile) to embed alternate network parameters.

## Archive contents

Each bundle contains a single directory named `agi-jobs-<variant>-<timestamp>/` with the following structure:

```
artifacts/             # sanitized ABI and address artifacts ready for operators and front-ends
config/                # governance timing, ENS, token, and registrar profiles for the selected variant
migrations/            # Truffle migrations for reproducible broadcasts
scripts/               # operational consoles, wizards, and automation helpers
INSTRUCTIONS.md        # generated deployment checklist and parameter summary
release-manifest.json  # structured manifest (version, git commit, configs, parameter values)
README.md, SECURITY.md, LICENSE, CHANGELOG.md  # reference documentation
```

The manifest includes the exact paths of the embedded configuration files so operators can highlight the fields that control
stake thresholds, ENS wiring, and Safe addresses during reviews. `INSTRUCTIONS.md` mirrors the deployment checklist printed in
this document and adds a bullet-list parameter diff (using the same formatting as `npm run config:params`).

## Operational checklist for bundle consumers

1. **Extract** the archive into a clean directory (for example, `tar -xzf agi-jobs-mainnet.tar.gz`).
2. **Install dependencies** with `npm ci` (Node.js 20+ recommended). The bundle ships with `package-lock.json` to guarantee
   deterministic installs.
3. **Review configuration** under `config/`:
   - `config/params.json` — lifecycle timings, governance thresholds, fee rates, and slash ceilings.
   - `config/ens.<variant>.json` — ENS registry, root nodes, and alpha activation flag.
   - `config/agialpha.<variant>.json` — staking token metadata and burn sink.
4. **Run diagnostics** (`npm run diagnose`) to confirm Node.js/npm versions, Hardhat/Truffle availability, and required
   environment variables (`MNEMONIC`, `RPC_MAINNET`, `RPC_SEPOLIA`, `ETHERSCAN_API_KEY`, `GOV_SAFE`, `TIMELOCK_ADDR`).
5. **Validate configuration** (`npm run config:validate`) to confirm the embedded guardrails still hold after local edits.
6. **Plan JobRegistry updates** with the automation tools packaged in `scripts/`:
   - Dry-run the configuration console: `npm run config:console -- --network mainnet status`.
   - Export Safe-ready plans: `npm run configure:registry -- --plan-out ./job-registry-plan.json`.
   - Use the owner console and Hardhat tasks to queue `extend`, `finalize`, `resolve`, or `timeout` actions before
     broadcasting (`--execute`).
7. **Archive evidence** — store `release-manifest.json`, generated plan files, and multisig calldata in long-term storage for
   audit trails and regression tracking.

## Updating parameters before bundling

The archive is designed to be regenerated after every governance decision:

1. Edit `config/params.json` with `npm run config:params` or supply scripted overrides using `-- --set key=value` flags.
2. Re-run `npm run config:validate` to catch ordering mistakes, threshold regressions, or invalid ENS roots.
3. Rebuild artifacts (`npm run export:artifacts`) if contract logic changed.
4. Invoke `npm run release:bundle -- --variant mainnet` again. The manifest timestamp and git commit help operators confirm the
   bundle reflects the latest governance snapshot.

## Non-technical operator tips

- The release archive can be shared privately without exposing development-only files. Each bundle is hermetic and tracks the
  exact configuration used to produce it.
- `INSTRUCTIONS.md` should be reviewed alongside Safe transaction plans. Operators can copy/paste the JSON payloads generated by
  the configuration console or Hardhat tasks directly into multisig dashboards.
- Keep previous bundles to build an immutable timeline of parameter changes and deployments. Comparing manifests makes it easy
  to spot threshold regressions or missing module addresses before signing transactions.

## Troubleshooting

- **Missing `artifacts-public`** — run `npm run export:artifacts` before invoking the bundler.
- **Unknown variant** — ensure `config/ens.<variant>.json` and `config/agialpha.<variant>.json` exist and pass validation.
- **Git commit unavailable** — the manifest still builds outside a Git checkout, but the `gitCommit` field will be `null`.
- **Archive verification** — extract the bundle and inspect `release-manifest.json`. It mirrors the data printed by
  `npm run config:params -- --dry-run` to keep reviewers aligned.

This workflow gives the contract owner complete control over lifecycle parameters and ensures every production bundle is
self-documenting, auditable, and ready for immediate deployment.
